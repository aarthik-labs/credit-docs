---
title: Server-Side Implementation (Example)
description: Step-by-step server-side setup for auth API integrations.
---

## Overview

This server is a minimal Express proxy used by the Aarthik Credit SDK. It keeps API keys on the server, performs the bootstrap token exchange, and forwards a small set of SDK routes to the upstream API. It also applies basic CORS handling, request logging, and timeouts so it is safe to use in local development or simple deployments.

## Requirements

- Node.js 18+ (uses the built-in `fetch` API)
- `express` installed in this repo

## Environment Variables

### Required

- `AARTHIK_API_KEY`
- `AARTHIK_TENANT_ID`
- `AARTHIK_APPLICATION_ID`

### Optional

- `AARTHIK_BASE_URL` (default: `https://staging.aarthikbandhu.com`)
- `PORT` (default: `3001`)
- `AARTHIK_ALLOWED_PARENT_ORIGIN` (single allowed origin)
- `AARTHIK_ALLOWED_PARENT_ORIGINS` (comma-separated list)
- `CLIENT_ORIGIN` (CORS override for local dev)
- `AARTHIK_STRICT_CORS` (`true` to reject unknown origins)
- `AARTHIK_PROXY_TIMEOUT_MS` (default: `30000`, minimum: `5000`)

## Sample Code

```javascript
import "dotenv/config";
import express from "express";

/**
 * Aarthik Credit SDK bootstrap server.
 *
 * Responsibilities:
 * - Provide a bootstrap token endpoint for the client app.
 * - Proxy a curated set of SDK endpoints to the Aarthik API.
 * - Apply basic CORS handling, logging, and timeouts.
 */

/* -------------------------------------------------------------------------- */
/* Configuration                                                             */
/* -------------------------------------------------------------------------- */

// Number parsing helper for envs that should be integers.
const parseInteger = (value, fallback) => {
  const parsed = Number.parseInt(value ?? "", 10);
  return Number.isNaN(parsed) ? fallback : parsed;
};

// Ensure base URL never ends with a trailing slash.
const normalizeBaseURL = (value) => value.replace(/\/$/, "");

// Core runtime settings.
const PORT = parseInteger(process.env.PORT, 3001);
const AARTHIK_BASE_URL = normalizeBaseURL(
  process.env.AARTHIK_BASE_URL ?? "https://staging.aarthikbandhu.com",
);

// Required credentials.
const AARTHIK_API_KEY = process.env.AARTHIK_API_KEY;
const AARTHIK_TENANT_ID = process.env.AARTHIK_TENANT_ID;
const AARTHIK_APPLICATION_ID = process.env.AARTHIK_APPLICATION_ID;

// Optional CORS configuration.
const AARTHIK_ALLOWED_PARENT_ORIGIN =
  process.env.AARTHIK_ALLOWED_PARENT_ORIGIN;
const CLIENT_ORIGIN =
  process.env.CLIENT_ORIGIN ?? AARTHIK_ALLOWED_PARENT_ORIGIN;
const STRICT_CORS = process.env.AARTHIK_STRICT_CORS === "true";

// Proxy timeout (minimum 5s).
const PROXY_TIMEOUT_MS = Math.max(
  parseInteger(process.env.AARTHIK_PROXY_TIMEOUT_MS, 30_000),
  5_000,
);

// Allowed origins list (comma-separated plus optional single origin).
const ALLOWED_ORIGINS = [
  ...(process.env.AARTHIK_ALLOWED_PARENT_ORIGINS ?? "")
    .split(",")
    .map((origin) => origin.trim())
    .filter(Boolean),
  ...(AARTHIK_ALLOWED_PARENT_ORIGIN ? [AARTHIK_ALLOWED_PARENT_ORIGIN] : []),
];

// Minimal status logs on startup.
console.log(
  `[bootstrap] base=${AARTHIK_BASE_URL} strictCORS=${STRICT_CORS} allowedOrigins=${ALLOWED_ORIGINS.length ? ALLOWED_ORIGINS.join(",") : "none"}`,
);
console.log(`[bootstrap] proxyTimeoutMS=${PROXY_TIMEOUT_MS}`);

/* -------------------------------------------------------------------------- */
/* Express setup                                                              */
/* -------------------------------------------------------------------------- */

const app = express();

// JSON body parsing for SDK requests.
app.use(express.json({ limit: "64kb" }));

// Request logging with optional correlation id.
app.use((req, res, next) => {
  const startedAt = Date.now();
  res.on("finish", () => {
    const durationMS = Date.now() - startedAt;
    const correlationID = res.getHeader("x-correlation-id");
    const correlationInfo =
      typeof correlationID === "string" ? ` cid=${correlationID}` : "";
    console.log(
      `[bootstrap] ${req.method} ${req.originalUrl} -> ${res.statusCode} (${durationMS}ms)${correlationInfo}`,
    );
  });
  next();
});

/* -------------------------------------------------------------------------- */
/* CORS handling                                                              */
/* -------------------------------------------------------------------------- */

// Extract origin header safely.
const getRequestOrigin = (req) =>
  typeof req.headers.origin === "string" ? req.headers.origin : undefined;

app.use((req, res, next) => {
  const requestOrigin = getRequestOrigin(req);

  // Default to client origin, request origin, or "*" if nothing else exists.
  let resolvedOrigin = CLIENT_ORIGIN ?? requestOrigin ?? "*";
  if (ALLOWED_ORIGINS.length > 0 && requestOrigin) {
    resolvedOrigin = ALLOWED_ORIGINS.includes(requestOrigin)
      ? requestOrigin
      : resolvedOrigin;
  }

  // Strict mode refuses unknown origins when allowlist is defined.
  if (
    STRICT_CORS &&
    ALLOWED_ORIGINS.length > 0 &&
    (!requestOrigin || !ALLOWED_ORIGINS.includes(requestOrigin))
  ) {
    res.status(403).json({ error: "origin_not_allowed" });
    return;
  }

  // Standard CORS headers for the SDK.
  res.setHeader("Access-Control-Allow-Origin", resolvedOrigin);
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader(
    "Access-Control-Allow-Headers",
    "authorization, content-type, idempotency-key, x-client-info, x-correlation-id, x-tenant-id",
  );
  res.setHeader("Access-Control-Expose-Headers", "x-correlation-id");

  // Answer preflight requests early.
  if (req.method === "OPTIONS") {
    res.sendStatus(204);
    return;
  }

  next();
});

/* -------------------------------------------------------------------------- */
/* Upstream helpers                                                           */
/* -------------------------------------------------------------------------- */

// Forward only the headers the upstream expects.
const FORWARD_HEADER_NAMES = [
  "authorization",
  "content-type",
  "idempotency-key",
  "x-client-info",
  "x-correlation-id",
  "x-tenant-id",
  "accept",
];

// Paths that should be proxied as-is to the upstream API.
const PROXY_PATHS = [
  "/api/auth/exchange",
  "/api/auth/refresh",
  "/api/auth/logout",
  "/api/sdk/provision",
  "/api/sdk/journey/select",
  "/api/sdk/journey/create",
  "/api/tenants/:tenant_id/applications/:application_id/borrowers/ensure",
];

// Helper to send JSON or text responses transparently.
const sendJSONOrText = async (upstreamResponse, res) => {
  const contentType = upstreamResponse.headers.get("content-type") ?? "";
  if (contentType.includes("application/json")) {
    const responseBody = await upstreamResponse.json();
    res.status(upstreamResponse.status).json(responseBody);
    return;
  }

  const responseText = await upstreamResponse.text();
  res.status(upstreamResponse.status).send(responseText);
};

/* -------------------------------------------------------------------------- */
/* Routes                                                                     */
/* -------------------------------------------------------------------------- */

// POST /api/bootstrap-token - exchanges allowed_parent_origin for a token.
app.post("/api/bootstrap-token", async (req, res) => {
  const missingEnv = [];
  if (!AARTHIK_API_KEY) missingEnv.push("AARTHIK_API_KEY");
  if (!AARTHIK_TENANT_ID) missingEnv.push("AARTHIK_TENANT_ID");
  if (!AARTHIK_APPLICATION_ID) missingEnv.push("AARTHIK_APPLICATION_ID");

  if (missingEnv.length > 0) {
    res.status(500).json({ error: "missing_env", missing: missingEnv });
    return;
  }

  // Read allowed_parent_origin from body, env, or validated request origin.
  const allowedParentOriginFromBody =
    typeof req.body?.allowed_parent_origin === "string"
      ? req.body.allowed_parent_origin
      : undefined;
  const requestOrigin = getRequestOrigin(req);
  const allowedParentOriginFromRequest =
    requestOrigin &&
    (ALLOWED_ORIGINS.length === 0 || ALLOWED_ORIGINS.includes(requestOrigin))
      ? requestOrigin
      : undefined;

  const allowedParentOrigin =
    allowedParentOriginFromBody ??
    AARTHIK_ALLOWED_PARENT_ORIGIN ??
    allowedParentOriginFromRequest;

  if (!allowedParentOrigin) {
    res.status(400).json({ error: "allowed_parent_origin_required" });
    return;
  }

  const bootstrapURL =
    `${AARTHIK_BASE_URL}/api/tenants/${AARTHIK_TENANT_ID}` +
    `/applications/${AARTHIK_APPLICATION_ID}/auth/bootstrap`;

  try {
    const upstreamResponse = await fetch(bootstrapURL, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        "x-api-key": AARTHIK_API_KEY,
      },
      body: JSON.stringify({ allowed_parent_origin: allowedParentOrigin }),
    });

    await sendJSONOrText(upstreamResponse, res);
  } catch (error) {
    console.error("Bootstrap token request failed:", error);
    res.status(500).json({ error: "bootstrap_token_request_failed" });
  }
});

// Proxy selected SDK routes to the Aarthik API.
app.post(PROXY_PATHS, async (req, res) => {
  const upstreamURL = `${AARTHIK_BASE_URL}${req.path}`;
  const upstreamHeaders = {};

  // Copy a safe subset of inbound headers.
  for (const headerName of FORWARD_HEADER_NAMES) {
    const value = req.headers[headerName];
    if (typeof value === "string" && value.length > 0) {
      upstreamHeaders[headerName] = value;
    }
  }

  const hasBody = req.body && Object.keys(req.body).length > 0;
  const controller = new AbortController();
  const timeoutID = setTimeout(() => controller.abort(), PROXY_TIMEOUT_MS);

  try {
    const upstreamResponse = await fetch(upstreamURL, {
      method: req.method,
      headers: upstreamHeaders,
      body: hasBody ? JSON.stringify(req.body) : undefined,
      signal: controller.signal,
    });

    const correlationID = upstreamResponse.headers.get("x-correlation-id");
    if (correlationID) {
      res.setHeader("x-correlation-id", correlationID);
    }

    await sendJSONOrText(upstreamResponse, res);
  } catch (error) {
    const isAbortError =
      error &&
      typeof error === "object" &&
      "name" in error &&
      error.name === "AbortError";

    console.error("Proxy request failed:", error);
    if (isAbortError) {
      res.status(504).json({ error: "upstream_timeout" });
      return;
    }

    res.status(502).json({ error: "upstream_request_failed" });
  } finally {
    clearTimeout(timeoutID);
  }
});

/* -------------------------------------------------------------------------- */
/* Server                                                                     */
/* -------------------------------------------------------------------------- */

// Start listening for incoming requests.
app.listen(PORT, () => {
  console.log(`Bootstrap server listening on http://localhost:${PORT}`);
});
```

## What the Server Does

### 1) Bootstrap Token Exchange

`POST /api/bootstrap-token`

- Reads `allowed_parent_origin` from:
  1. Request body (`allowed_parent_origin`)
  2. `AARTHIK_ALLOWED_PARENT_ORIGIN`
  3. Request origin header (only if it is allowlisted)
- Calls the upstream bootstrap endpoint:
  `POST /api/tenants/{tenant_id}/applications/{application_id}/auth/bootstrap`
- Returns the upstream JSON (or text) response as-is.

### 2) Proxy Selected SDK Routes

The server proxies the following routes to `AARTHIK_BASE_URL`:

- `/api/auth/exchange`
- `/api/auth/refresh`
- `/api/auth/logout`
- `/api/sdk/provision`
- `/api/sdk/journey/select`
- `/api/sdk/journey/create`
- `/api/tenants/:tenant_id/applications/:application_id/borrowers/ensure`

For proxied requests, it forwards a safe header subset:

- `authorization`
- `content-type`
- `idempotency-key`
- `x-client-info`
- `x-correlation-id`
- `x-tenant-id`
- `accept`

Responses are returned as JSON or plain text depending on upstream content type. If the upstream response includes `x-correlation-id`, it is forwarded to the client.

### 3) CORS Behavior

- Allows `POST` and `OPTIONS` requests.
- Uses `CLIENT_ORIGIN` when provided, otherwise the request origin, otherwise `*`.
- If `AARTHIK_ALLOWED_PARENT_ORIGINS` or `AARTHIK_ALLOWED_PARENT_ORIGIN` is set, only those origins are allowlisted.
- If `AARTHIK_STRICT_CORS=true`, requests from unknown origins are rejected with `403`.

### 4) Logging and Timeouts

- Logs each request with status code and latency.
- Aborts upstream requests that exceed `AARTHIK_PROXY_TIMEOUT_MS`.

## Run Locally

```bash
pnpm add express

AARTHIK_API_KEY=your_api_key \
AARTHIK_TENANT_ID=your_tenant_id \
AARTHIK_APPLICATION_ID=your_application_id \
AARTHIK_ALLOWED_PARENT_ORIGIN=http://localhost:5173 \
node bootstrap-server.js
```

## Example Request

```bash
curl -X POST \
  http://localhost:3001/api/bootstrap-token \
  -H "content-type: application/json" \
  -d '{"allowed_parent_origin":"http://localhost:5173"}'
```

## Notes

- This server is intentionally small so it can be embedded in SDK documentation.
- You can deploy it as-is for simple use cases, or adapt it to your production stack.
